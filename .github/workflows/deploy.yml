name: Build and Deploy Flutter Web to RefinedStone.github.io

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Compute deploy subdir and base href
        env:
          CUSTOM_SUBDIR: ${{ vars.PAGES_SUBDIR }}
        run: |
          SOURCE_REPO="${GITHUB_REPOSITORY#*/}"
          SUBDIR="${CUSTOM_SUBDIR:-$SOURCE_REPO}"

          SUBDIR="${SUBDIR#/}"
          SUBDIR="${SUBDIR%/}"
          if [ -z "$SUBDIR" ]; then
            SUBDIR="."
            BASE_HREF="/"
          elif [ "$SUBDIR" = "." ]; then
            BASE_HREF="/"
          else
            BASE_HREF="/${SUBDIR}/"
          fi

          echo "DEPLOY_SUBDIR=$SUBDIR" >> "$GITHUB_ENV"
          echo "BASE_HREF=$BASE_HREF" >> "$GITHUB_ENV"
          echo "Using subdir: $SUBDIR with base href $BASE_HREF"

      - name: Build Flutter Web
        run: flutter build web --release --base-href "$BASE_HREF"

      - name: Add .nojekyll
        run: echo "" > build/web/.nojekyll

      - name: Checkout akra-devs.github.io
        uses: actions/checkout@v4
        with:
          repository: akra-devs/akra-devs.github.io
          token: ${{ secrets.PERSONAL_TOKEN }}
          path: site
          fetch-depth: 1

      - name: Copy build output into docs subdir
        run: |
          TARGET_DIR="site/docs"
          if [ "$DEPLOY_SUBDIR" != "." ]; then
            TARGET_DIR="$TARGET_DIR/$DEPLOY_SUBDIR"
          fi

          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          cp -R build/web/* "$TARGET_DIR/"

      - name: Commit and push to akra-devs.github.io
        run: |
          cd site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ "$DEPLOY_SUBDIR" = "." ]; then
            git add docs
          else
            git add "docs/$DEPLOY_SUBDIR"
          fi
          git commit -m "Deploy ${DEPLOY_SUBDIR} from CI" || echo "No changes to commit"
          git push origin main
